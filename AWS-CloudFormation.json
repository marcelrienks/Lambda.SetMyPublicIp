{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "a87e9281-9642-4527-a0d1-dfcc21b60e8b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -150,
                    "y": 50
                },
                "z": 1,
                "embeds": []
            },
            "d359d69b-cbe4-4ad6-be39-308eeac3d136": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -20,
                    "y": 50
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "aeeead1c-5ef1-42d1-97e0-1906533435e1",
                    "aaace790-31a8-4987-b8a0-4f389a468570"
                ]
            },
            "aaace790-31a8-4987-b8a0-4f389a468570": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 100,
                    "y": 50
                },
                "z": 1,
                "embeds": []
            },
            "2af110c6-c577-403d-b6c3-ba5b9e1a7a45": {
                "size": {
                    "width": 450,
                    "height": 410
                },
                "position": {
                    "x": -153,
                    "y": 142
                },
                "z": 0,
                "embeds": [
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292"
                ]
            },
            "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292": {
                "size": {
                    "width": 420,
                    "height": 360
                },
                "position": {
                    "x": -140,
                    "y": 170
                },
                "z": 1,
                "parent": "2af110c6-c577-403d-b6c3-ba5b9e1a7a45",
                "embeds": [
                    "b8f786fc-647d-4128-9466-a09bf1da447c"
                ],
                "iscontainedinside": [
                    "2af110c6-c577-403d-b6c3-ba5b9e1a7a45"
                ]
            },
            "b8f786fc-647d-4128-9466-a09bf1da447c": {
                "size": {
                    "width": 390,
                    "height": 310
                },
                "position": {
                    "x": -130,
                    "y": 200
                },
                "z": 2,
                "parent": "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                "embeds": [
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d"
                ],
                "iscontainedinside": [
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292",
                    "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292"
                ]
            },
            "a4548f89-41fb-4d94-990c-0f9a4e6e267d": {
                "size": {
                    "width": 360,
                    "height": 260
                },
                "position": {
                    "x": -120,
                    "y": 230
                },
                "z": 3,
                "parent": "b8f786fc-647d-4128-9466-a09bf1da447c",
                "embeds": [
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52"
                ],
                "iscontainedinside": [
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c",
                    "b8f786fc-647d-4128-9466-a09bf1da447c"
                ]
            },
            "5b70e59c-1b2b-4130-8189-0a5de5e78d52": {
                "size": {
                    "width": 330,
                    "height": 210
                },
                "position": {
                    "x": -110,
                    "y": 260
                },
                "z": 4,
                "parent": "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                "embeds": [
                    "cb542ef9-bdaf-4189-bd18-e98699b6815a",
                    "0fe3d001-9e5c-4c8d-904f-c4468da1d8f3",
                    "2317c5f0-a7cd-4b40-9cd2-1e5723a4e573"
                ],
                "iscontainedinside": [
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d",
                    "a4548f89-41fb-4d94-990c-0f9a4e6e267d"
                ]
            },
            "2317c5f0-a7cd-4b40-9cd2-1e5723a4e573": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -90,
                    "y": 290
                },
                "z": 5,
                "parent": "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                "embeds": [],
                "isassociatedwith": [
                    "0fe3d001-9e5c-4c8d-904f-c4468da1d8f3"
                ],
                "iscontainedinside": [
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                    "5b70e59c-1b2b-4130-8189-0a5de5e78d52"
                ]
            },
            "0fe3d001-9e5c-4c8d-904f-c4468da1d8f3": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 10,
                    "y": 290
                },
                "z": 5,
                "parent": "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                "embeds": []
            },
            "cb542ef9-bdaf-4189-bd18-e98699b6815a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 10,
                    "y": 370
                },
                "z": 5,
                "parent": "5b70e59c-1b2b-4130-8189-0a5de5e78d52",
                "embeds": []
            },
            "bcdd14f4-2405-4125-addf-5446dc1658f9": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -260,
                    "y": 50
                },
                "z": 0
            }
        }
    },
    "Parameters": {
        "HostedZoneId": {
            "Type": "AWS::Route53::HostedZone::Id",
            "Description": "The Route53 Hosted Zone ID containing the domain that should have it's recordet updated with a public IP"
        },
        "S3BucketName": {
            "Type": "String",
            "Description": "The name of an S3 bucket (same region as CloudFormation stack) that the packaged Lambda will reside in"
        },
        "S3ZipKey": {
            "Type": "String",
            "Description": "The key of the packaged Lambda that has been uploaded to S3"
        }
    },
    "Resources": {
        "SetMyPublicIpLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": "SetMyPublicIp2",
                "Description": "Function to set the IP address of a Route 53 domain to the public IP of the calling client",
                "Handler": "not_required_for_custom_runtime",
                "MemorySize": 128,
                "Runtime": "provided",
                "Role": {
                    "Fn::GetAtt": [
                        "MySetMyPublicIpLambdaRole",
                        "Arn"
                    ]
                },
                "Code": {
                    "S3Bucket": {
                        "Ref": "S3BucketName"
                    },
                    "S3Key": {
                        "Ref": "S3ZipKey"
                    }
                },
                "Timeout": 15
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a87e9281-9642-4527-a0d1-dfcc21b60e8b"
                }
            },
            "DependsOn": [
                "MySetMyPublicIpLambdaRole"
            ]
        },
        "MySetMyPublicIpLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Description": "Allows the Lambda SetMyPublicIp to access other AWS services",
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    {
                        "Ref": "MySetMyPublicIpRoute53Policy"
                    }
                ],
                "RoleName": "My.SetMyPublicIp.Lambda.Role.2"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "d359d69b-cbe4-4ad6-be39-308eeac3d136"
                }
            },
            "DependsOn": [
                "MySetMyPublicIpRoute53Policy"
            ]
        },
        "MySetMyPublicIpRoute53Policy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "route53:ChangeResourceRecordSets"
                            ],
                            "Resource": [
                                "arn:aws:route53:::change/*",
                                {
                                    "Fn::Sub": [
                                        "arn:aws:route53:::hostedzone/${HostedZoneIdValue}",
                                        {
                                            "HostedZoneIdValue": {
                                                "Ref": "HostedZoneId"
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "Description": "Permission to allow the Lambda SetMyPublicIp access to change a specific hosted zone's record set",
                "ManagedPolicyName": "My.SetMyPublicIp.Route53.Policy.2"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "aaace790-31a8-4987-b8a0-4f389a468570"
                }
            }
        },
        "SetMyPublicIpRestApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "ApiKeySourceType": "HEADER",
                "Description": "Api gateway to handle entry into the SetMyPublicIp lambda function",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "FailOnWarnings": true,
                "Name": "SetMyPublicIpTwo"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2af110c6-c577-403d-b6c3-ba5b9e1a7a45"
                }
            }
        },
        "HostedzoneResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "SetMyPublicIpTwo"
                },
                "PathPart": "hostedzone"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "cb3361e1-cf59-4c5b-aa51-f2e0a93c3292"
                }
            }
        },
        "HostedzoneResourceParameter": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "ParentId": {
                    "Ref": "HostedzoneResource"
                },
                "PathPart": "{hostedzoneid}"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b8f786fc-647d-4128-9466-a09bf1da447c"
                }
            }
        },
        "DomainResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "ParentId": {
                    "Ref": "HostedzoneResourceParameter"
                },
                "PathPart": "domain"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a4548f89-41fb-4d94-990c-0f9a4e6e267d"
                }
            }
        },
        "DomainResourceParameter": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "ParentId": {
                    "Ref": "DomainResource"
                },
                "PathPart": "{domainname}"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "5b70e59c-1b2b-4130-8189-0a5de5e78d52"
                }
            }
        },
        "SetMyPublicIpPatchMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "ResourceId": {
                    "Ref": "DomainResourceParameter"
                },
                "AuthorizationType": "AWS_IAM",
                "HttpMethod": "PATCH",
                "OperationName": "Set my public IP",
                "RequestParameters": {
                    "method.request.path.hostedzoneid": true,
                    "method.request.path.domainname": true,
                    "method.request.header.x-forwarded-for": true
                },
                "RequestModels": [
                    {
                        "Ref": "SetMyPublicIpRequestModel"
                    }
                ],
                "MethodResponses": [
                    {
                        "ResponseModels": [
                            {
                                "Ref": "SetMyPublicIpResponseModel"
                            }
                        ],
                        "StatusCode": "202"
                    }
                ],
                "Integration": {
                    "ConnectionType": "INTERNET",
                    "Type": "AWS",
                    "IntegrationResponses": [
                        {
                            
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2317c5f0-a7cd-4b40-9cd2-1e5723a4e573"
                }
            }
        },
        "SetMyPublicIpRequestModel": {
            "Type": "AWS::ApiGateway::Model",
            "Properties": {
                "ContentType": "application/json",
                "Name": "SetMyPublicIpRequest",
                "Description": "Request model for SetMyPublicIp Lambda",
                "RestApiId": {
                    "Ref": "SetMyPublicIpTwo"
                },
                "Schema": {
                    "$schema": "http://json-schema.org/draft-04/schema#",
                    "title": "Request",
                    "type": "object",
                    "properties": {
                        "HostedZoneId": {
                            "type": "string"
                        },
                        "DomainName": {
                            "type": "string"
                        },
                        "PublicIps": {
                            "type": "string"
                        }
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0fe3d001-9e5c-4c8d-904f-c4468da1d8f3"
                }
            }
        },
        "SetMyPublicIpResponseModel": {
            "Type": "AWS::ApiGateway::Model",
            "Properties": {
                "ContentType": "application/json",
                "Name": "SetMyPublicIpResponse",
                "Description": "Response model for SetMyPublicIp Lambda",
                "RestApiId": {
                    "Ref": "SetMyPublicIpTwo"
                },
                "Schema": {
                    "$schema": "http://json-schema.org/draft-04/schema#",
                    "title": "Request",
                    "type": "object",
                    "properties": {
                        "ChangeRequestId": {
                            "type": "string"
                        },
                        "ChangeRequestStatus": {
                            "type": "string"
                        },
                        "PublicIp": {
                            "type": "string"
                        }
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "cb542ef9-bdaf-4189-bd18-e98699b6815a"
                }
            }
        },
        "LP4TWK1": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "bcdd14f4-2405-4125-addf-5446dc1658f9"
                }
            }
        }
    }
}
